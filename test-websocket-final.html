<!DOCTYPE html>
<html>
  <head>
    <title>WebSocket Test - Final</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .log {
        background: #f0f0f0;
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
      }
      .success {
        color: green;
      }
      .error {
        color: red;
      }
      .info {
        color: blue;
      }
      .warning {
        color: orange;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        cursor: pointer;
      }
      input {
        padding: 8px;
        margin: 5px;
        width: 300px;
      }
    </style>
  </head>
  <body>
    <h1>WebSocket Connection Test - Final</h1>

    <div>
      <input
        type="text"
        id="tokenInput"
        placeholder="Paste your JWT token here..."
      />
      <button onclick="testWithToken()">Test with Token</button>
      <button onclick="autoGetToken()">Auto Get Token</button>
      <button onclick="clearLogs()">Clear Logs</button>
    </div>

    <div id="logs"></div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
      function log(message, type = "info") {
        const logs = document.getElementById("logs");
        const div = document.createElement("div");
        div.className = `log ${type}`;
        div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logs.appendChild(div);
      }

      function clearLogs() {
        document.getElementById("logs").innerHTML = "";
      }

      function autoGetToken() {
        log("üîç Trying to get token automatically...", "info");

        // Try localStorage first
        let token = localStorage.getItem("accessToken");
        if (token) {
          log("‚úÖ Token found in localStorage", "success");
          document.getElementById("tokenInput").value = token;
          testWithToken();
          return;
        }

        // Try cookies
        const cookies = document.cookie.split(";");
        const tokenCookie = cookies.find((cookie) =>
          cookie.trim().startsWith("accessToken=")
        );
        if (tokenCookie) {
          token = decodeURIComponent(tokenCookie.split("=")[1]);
          log("‚úÖ Token found in cookies", "success");
          document.getElementById("tokenInput").value = token;
          testWithToken();
          return;
        }

        log(
          "‚ùå No token found. Please login first or paste token manually.",
          "error"
        );
        log("üí° Steps to get token:", "info");
        log("1. Go to http://localhost:3002", "info");
        log("2. Login to the system", "info");
        log("3. Open Developer Tools (F12)", "info");
        log('4. Run: localStorage.getItem("accessToken")', "info");
        log("5. Copy the token and paste it above", "info");
      }

      function testWithToken() {
        const token = document.getElementById("tokenInput").value.trim();

        if (!token) {
          log("‚ùå Please enter a token first", "error");
          return;
        }

        log("üîç Testing WebSocket connection...", "info");
        log(`Token: ${token.substring(0, 20)}...`, "info");
        log(`Token length: ${token.length}`, "info");

        // Test WebSocket connection
        const socket = io("http://localhost:4000", {
          path: "/ws",
          auth: { token: token },
          extraHeaders: { Authorization: `Bearer ${token}` },
          transports: ["websocket", "polling"],
          timeout: 10000,
        });

        socket.on("connect", () => {
          log("‚úÖ WebSocket connected successfully!", "success");
          log(`Socket ID: ${socket.id}`, "info");
          log("üéâ WebSocket is working properly!", "success");
          socket.disconnect();
        });

        socket.on("connect_error", (error) => {
          log(`‚ùå WebSocket error: ${error.message}`, "error");
          log(`Error type: ${error.type}`, "error");
          log(`Error description: ${error.description}`, "error");

          if (error.message.includes("Invalid token")) {
            log("üí° Token validation failed. Possible causes:", "warning");
            log("- Token is expired", "warning");
            log("- Token format is invalid", "warning");
            log(
              "- JWT secret mismatch between frontend and backend",
              "warning"
            );
          }
        });

        socket.on("disconnect", (reason) => {
          log(`üîå Disconnected: ${reason}`, "info");
        });

        // Timeout after 15 seconds
        setTimeout(() => {
          if (!socket.connected) {
            log("‚è∞ Connection timeout after 15 seconds", "warning");
            socket.disconnect();
          }
        }, 15000);
      }

      // Auto-try to get token when page loads
      window.onload = function () {
        log("üöÄ WebSocket Test Page Loaded", "info");
        log(
          'Click "Auto Get Token" to automatically retrieve your token',
          "info"
        );
      };
    </script>
  </body>
</html>

