<!DOCTYPE html>
<html>
  <head>
    <title>Token Debug</title>
  </head>
  <body>
    <h1>Token Debug</h1>
    <div id="output"></div>

    <script>
      function debugToken() {
        const output = document.getElementById("output");
        let html = "<h2>Token Debug Information:</h2>";

        // Check localStorage
        html += "<h3>LocalStorage:</h3>";
        try {
          const accessToken = localStorage.getItem("accessToken");
          const refreshToken = localStorage.getItem("refreshToken");
          html += `<p>accessToken: ${accessToken ? "EXISTS" : "NOT FOUND"}</p>`;
          html += `<p>refreshToken: ${
            refreshToken ? "EXISTS" : "NOT FOUND"
          }</p>`;

          if (accessToken) {
            try {
              const payload = JSON.parse(atob(accessToken.split(".")[1]));
              html += `<p>Token payload: ${JSON.stringify(
                payload,
                null,
                2
              )}</p>`;
              html += `<p>Token expires: ${new Date(
                payload.exp * 1000
              ).toLocaleString()}</p>`;
              html += `<p>Token expired: ${
                Date.now() > payload.exp * 1000 ? "YES" : "NO"
              }</p>`;
            } catch (e) {
              html += `<p>Error parsing token: ${e.message}</p>`;
            }
          }
        } catch (e) {
          html += `<p>Error accessing localStorage: ${e.message}</p>`;
        }

        // Check cookies
        html += "<h3>Cookies:</h3>";
        const cookies = document.cookie.split(";");
        const tokenCookie = cookies.find((cookie) =>
          cookie.trim().startsWith("accessToken=")
        );
        html += `<p>accessToken cookie: ${
          tokenCookie ? "EXISTS" : "NOT FOUND"
        }</p>`;
        if (tokenCookie) {
          const token = tokenCookie.split("=")[1];
          html += `<p>Cookie token: ${token ? "EXISTS" : "NOT FOUND"}</p>`;
        }

        // Check all cookies
        html += "<h3>All Cookies:</h3>";
        html += `<p>${document.cookie || "No cookies found"}</p>`;

        // Test API call
        html += "<h3>API Test:</h3>";
        testAPICall()
          .then((result) => {
            html += `<p>API Test Result: ${result}</p>`;
            output.innerHTML = html;
          })
          .catch((error) => {
            html += `<p>API Test Error: ${error.message}</p>`;
            output.innerHTML = html;
          });
      }

      async function testAPICall() {
        try {
          const token =
            localStorage.getItem("accessToken") ||
            document.cookie
              .split(";")
              .find((c) => c.trim().startsWith("accessToken="))
              ?.split("=")[1];

          if (!token) {
            return "No token found";
          }

          const response = await fetch(
            "http://localhost:4000/api/v1/conferences/1/sessions",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({
                TITLE: "Test Session",
                DESCRIPTION: "Test Description",
                START_TIME: "2024-12-20T10:00:00.000Z",
                END_TIME: "2024-12-20T11:00:00.000Z",
                SPEAKER: "Test Speaker",
                ROOM_ID: null,
                STATUS: "upcoming",
              }),
            }
          );

          const result = await response.text();
          return `Status: ${response.status}, Response: ${result}`;
        } catch (error) {
          return `Error: ${error.message}`;
        }
      }

      // Run debug when page loads
      window.onload = debugToken;
    </script>
  </body>
</html>
