<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Conference Timing Fix</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .warning { color: orange; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 3px; }
        button:hover { background: #0056b3; }
        .test-link { display: block; margin: 10px 0; padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 3px; text-decoration: none; color: #007bff; }
        .test-link:hover { background: #e9ecef; }
        .fix-summary { background: #d4edda; border: 1px solid #c3e6cb; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .timing-issue { background: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; border-radius: 5px; margin: 20px 0; }
    </style>
</head>
<body>
    <h1>ğŸ”§ Test Conference Timing Fix</h1>
    
    <div class="timing-issue">
        <h2>ğŸš¨ Váº¥n Ä‘á» Ä‘Ã£ phÃ¡t hiá»‡n:</h2>
        <p><strong>Timing Issue:</strong> <code>useConferencePermissions</code> Ä‘Æ°á»£c gá»i vá»›i <code>{isAuthenticated: false, user: null}</code> máº·c dÃ¹ user Ä‘Ã£ Ä‘Æ°á»£c authenticate.</p>
        <p><strong>NguyÃªn nhÃ¢n:</strong> Hook Ä‘Æ°á»£c gá»i trÆ°á»›c khi <code>useAuth</code> hoÃ n thÃ nh viá»‡c load user data.</p>
        <p><strong>Káº¿t quáº£:</strong> <code>conferencePermissions</code> bá»‹ set vá» <code>[]</code> vÃ  khÃ´ng cÃ³ quyá»n truy cáº­p.</p>
    </div>
    
    <div class="fix-summary">
        <h2>âœ… CÃ¡c thay Ä‘á»•i Ä‘Ã£ thá»±c hiá»‡n:</h2>
        <ul>
            <li><strong>ThÃªm authLoading check:</strong> Kiá»ƒm tra <code>authLoading</code> trÆ°á»›c khi gá»i API</li>
            <li><strong>Wait for auth:</strong> Chá» auth hoÃ n thÃ nh loading trÆ°á»›c khi fetch permissions</li>
            <li><strong>Prevent premature redirects:</strong> Return false trong permission checks khi Ä‘ang loading</li>
            <li><strong>Update isLoading:</strong> Bao gá»“m <code>authLoading</code> trong <code>isLoading</code> state</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>ğŸ§ª Test Cases</h2>
        <p>Click vÃ o cÃ¡c link sau Ä‘á»ƒ test xem cÃ³ cÃ²n bá»‹ redirect vá» /dashboard khÃ´ng:</p>
        
        <h3>Test 1: Conference Pages vá»›i conferenceId trong URL</h3>
        <a href="/attendees?conferenceId=1" class="test-link" target="_blank">
            ğŸ“‹ /attendees?conferenceId=1
        </a>
        <a href="/checkin?conferenceId=1" class="test-link" target="_blank">
            ğŸ“± /checkin?conferenceId=1
        </a>
        <a href="/networking?conferenceId=1" class="test-link" target="_blank">
            ğŸŒ /networking?conferenceId=1
        </a>
        <a href="/venue?conferenceId=1" class="test-link" target="_blank">
            ğŸ“ /venue?conferenceId=1
        </a>
        <a href="/sessions?conferenceId=1" class="test-link" target="_blank">
            ğŸ¥ /sessions?conferenceId=1
        </a>
        <a href="/badges?conferenceId=1" class="test-link" target="_blank">
            ğŸ† /badges?conferenceId=1
        </a>
        <a href="/analytics?conferenceId=1" class="test-link" target="_blank">
            ğŸ“Š /analytics?conferenceId=1
        </a>

        <h3>Test 2: Conference Pages vá»›i conferenceId khÃ¡c</h3>
        <a href="/attendees?conferenceId=3" class="test-link" target="_blank">
            ğŸ“‹ /attendees?conferenceId=3
        </a>
        <a href="/checkin?conferenceId=3" class="test-link" target="_blank">
            ğŸ“± /checkin?conferenceId=3
        </a>

        <h3>Test 3: Conference Pages khÃ´ng cÃ³ conferenceId</h3>
        <a href="/attendees" class="test-link" target="_blank">
            ğŸ“‹ /attendees (no conferenceId)
        </a>
        <a href="/checkin" class="test-link" target="_blank">
            ğŸ“± /checkin (no conferenceId)
        </a>

        <h3>Test 4: Conference Detail Page</h3>
        <a href="/conferences/1" class="test-link" target="_blank">
            ğŸ¢ /conferences/1
        </a>
        <a href="/conferences/3" class="test-link" target="_blank">
            ğŸ¢ /conferences/3
        </a>
    </div>

    <div class="test-section">
        <h2>ğŸ” Debug Information</h2>
        <button onclick="checkCurrentState()">Check Current State</button>
        <div id="debug-info"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“ Expected Console Logs</h2>
        <p><strong>TrÆ°á»›c khi sá»­a (âŒ Lá»—i):</strong></p>
        <pre class="error">useConferencePermissions - fetchConferencePermissions called {isAuthenticated: false, user: null}
useConferencePermissions - not authenticated or no user, setting empty permissions</pre>
        
        <p><strong>Sau khi sá»­a (âœ… ÄÃºng):</strong></p>
        <pre class="success">useConferencePermissions - fetchConferencePermissions called {isAuthenticated: true, user: {...}, authLoading: false}
useConferencePermissions - starting API call for user: 1
useConferencePermissions - permissions: (2) [{â€¦}, {â€¦}]
useConferencePermissions - using first active conference: 3</pre>
    </div>

    <div class="test-section">
        <h2>ğŸ“ Expected Behavior</h2>
        <ul>
            <li class="success">âœ… KhÃ´ng cÃ²n tháº¥y <code>isAuthenticated: false, user: null</code> trong logs</li>
            <li class="success">âœ… Tháº¥y <code>authLoading: false</code> trÆ°á»›c khi gá»i API</li>
            <li class="success">âœ… CÃ¡c trang conference sáº½ load bÃ¬nh thÆ°á»ng</li>
            <li class="success">âœ… KhÃ´ng cÃ²n bá»‹ redirect vá» <code>/dashboard</code> khÃ´ng mong muá»‘n</li>
            <li class="success">âœ… Sidebar links sáº½ hoáº¡t Ä‘á»™ng Ä‘Ãºng</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>ğŸ”§ Technical Details</h2>
        <p><strong>Váº¥n Ä‘á» Ä‘Ã£ sá»­a:</strong></p>
        <ul>
            <li>Timing issue giá»¯a <code>useAuth</code> vÃ  <code>useConferencePermissions</code></li>
            <li>Gá»i API trÆ°á»›c khi auth hoÃ n thÃ nh loading</li>
            <li>Permission checks tráº£ vá» false khi Ä‘ang loading</li>
        </ul>
        
        <p><strong>Giáº£i phÃ¡p:</strong></p>
        <ul>
            <li>ThÃªm <code>authLoading</code> check trong <code>useEffect</code></li>
            <li>Chá» auth hoÃ n thÃ nh trÆ°á»›c khi fetch permissions</li>
            <li>Return false trong permission checks khi Ä‘ang loading</li>
            <li>Bao gá»“m <code>authLoading</code> trong <code>isLoading</code> state</li>
        </ul>
    </div>

    <script>
        function checkCurrentState() {
            const debugDiv = document.getElementById('debug-info');
            debugDiv.innerHTML = '<p class="info">Checking current state...</p>';

            // Check URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const conferenceId = urlParams.get('conferenceId');
            
            // Check cookies
            const token = getCookie('accessToken');
            
            let debugInfo = `
                <h3>Current State:</h3>
                <pre>URL: ${window.location.href}
Pathname: ${window.location.pathname}
ConferenceId from URL: ${conferenceId || 'None'}
Access Token: ${token ? 'Found' : 'Not found'}</pre>
                
                <h3>Expected Console Logs (After Fix):</h3>
                <ul>
                    <li class="success">âœ… useConferencePermissions - fetchConferencePermissions called {isAuthenticated: true, user: {...}, authLoading: false}</li>
                    <li class="success">âœ… useConferencePermissions - starting API call for user: 1</li>
                    <li class="success">âœ… useConferencePermissions - permissions: (2) [{â€¦}, {â€¦}]</li>
                    <li class="success">âœ… using first active conference: 3 hoáº·c using URL conferenceId: X</li>
                    <li class="error">âŒ KHÃ”NG tháº¥y isAuthenticated: false, user: null</li>
                </ul>
            `;

            debugDiv.innerHTML = debugInfo;
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        // Auto-check on load
        window.onload = function() {
            checkCurrentState();
        };
    </script>
</body>
</html>
