<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Debug localStorage Tokens</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .token-info {
        background: #f5f5f5;
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
      }
      .token-value {
        word-break: break-all;
        font-family: monospace;
      }
      .no-token {
        color: #666;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <h1>üîç Debug localStorage Tokens</h1>
    <p>This page helps debug token storage issues in the AI Analytics page.</p>

    <div class="token-info">
      <h3>localStorage Tokens:</h3>
      <div id="localStorage-tokens"></div>
    </div>

    <div class="token-info">
      <h3>sessionStorage Tokens:</h3>
      <div id="sessionStorage-tokens"></div>
    </div>

    <div class="token-info">
      <h3>Cookies:</h3>
      <div id="cookies"></div>
    </div>

    <div class="token-info">
      <h3>Test API Call:</h3>
      <button onclick="testAPICall()">Test API with current token</button>
      <div id="api-result"></div>
    </div>

    <script>
      function displayTokens() {
        // Check localStorage
        const localStorageDiv = document.getElementById("localStorage-tokens");
        const localStorageTokens = ["accessToken", "refreshToken", "token"];
        let localStorageHTML = "";

        localStorageTokens.forEach((key) => {
          const value = localStorage.getItem(key);
          if (value) {
            localStorageHTML += `<div><strong>${key}:</strong> <span class="token-value">${value.substring(
              0,
              50
            )}...</span></div>`;
          } else {
            localStorageHTML += `<div class="no-token">${key}: Not found</div>`;
          }
        });
        localStorageDiv.innerHTML =
          localStorageHTML ||
          '<div class="no-token">No tokens found in localStorage</div>';

        // Check sessionStorage
        const sessionStorageDiv = document.getElementById(
          "sessionStorage-tokens"
        );
        const sessionStorageTokens = ["accessToken", "refreshToken", "token"];
        let sessionStorageHTML = "";

        sessionStorageTokens.forEach((key) => {
          const value = sessionStorage.getItem(key);
          if (value) {
            sessionStorageHTML += `<div><strong>${key}:</strong> <span class="token-value">${value.substring(
              0,
              50
            )}...</span></div>`;
          } else {
            sessionStorageHTML += `<div class="no-token">${key}: Not found</div>`;
          }
        });
        sessionStorageDiv.innerHTML =
          sessionStorageHTML ||
          '<div class="no-token">No tokens found in sessionStorage</div>';

        // Check cookies
        const cookiesDiv = document.getElementById("cookies");
        const cookies = document.cookie.split(";");
        let cookiesHTML = "";

        if (cookies.length > 0 && cookies[0] !== "") {
          cookies.forEach((cookie) => {
            const [name, value] = cookie.trim().split("=");
            if (name.includes("token") || name.includes("Token")) {
              cookiesHTML += `<div><strong>${name}:</strong> <span class="token-value">${
                value ? value.substring(0, 50) + "..." : "empty"
              }</span></div>`;
            }
          });
        }
        cookiesDiv.innerHTML =
          cookiesHTML ||
          '<div class="no-token">No token-related cookies found</div>';
      }

      async function testAPICall() {
        const resultDiv = document.getElementById("api-result");
        resultDiv.innerHTML = "<div>Testing API call...</div>";

        try {
          // Try to get token using the same logic as the AI analytics page
          const sources = [
            () => {
              const cookies = document.cookie.split(";");
              const tokenCookie = cookies.find((cookie) =>
                cookie.trim().startsWith("accessToken=")
              );
              if (tokenCookie) {
                return tokenCookie.split("=")[1];
              }
              return null;
            },
            () => localStorage.getItem("accessToken"),
            () => localStorage.getItem("token"),
            () => sessionStorage.getItem("accessToken"),
            () => sessionStorage.getItem("token"),
          ];

          let token = null;
          for (const source of sources) {
            try {
              const t = source();
              if (t && t.trim() !== "") {
                token = t;
                break;
              }
            } catch (error) {
              console.warn("Error accessing token source:", error);
            }
          }

          if (!token) {
            resultDiv.innerHTML =
              '<div style="color: red;">‚ùå No token found</div>';
            return;
          }

          const response = await fetch(
            "http://localhost:4000/api/v1/analytics/global-ai",
            {
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            }
          );

          const data = await response.json();

          if (response.ok) {
            resultDiv.innerHTML =
              '<div style="color: green;">‚úÖ API call successful! Data received.</div>';
          } else {
            resultDiv.innerHTML = `<div style="color: red;">‚ùå API call failed: ${
              response.status
            } - ${data.error?.message || "Unknown error"}</div>`;
          }
        } catch (error) {
          resultDiv.innerHTML = `<div style="color: red;">‚ùå Error: ${error.message}</div>`;
        }
      }

      // Load tokens on page load
      displayTokens();

      // Refresh every 2 seconds
      setInterval(displayTokens, 2000);
    </script>
  </body>
</html>
