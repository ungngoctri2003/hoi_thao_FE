<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Conference Flow</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
        .warning { background: #fff3e0; color: #f57c00; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .step { 
            background: #e8f5e8; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 4px; 
            border-left: 4px solid #4caf50;
        }
        .conference-item { 
            background: #e3f2fd; 
            padding: 10px; 
            margin: 5px 0; 
            border-radius: 4px; 
            border-left: 4px solid #2196f3;
        }
    </style>
</head>
<body>
    <h1>Test Conference Flow</h1>
    
    <div>
        <button onclick="testFullFlow()">Test Full Flow</button>
        <button onclick="testAPI()">Test API Call</button>
        <button onclick="clearResults()">Clear Results</button>
    </div>
    
    <div id="results"></div>

    <script>
        const API_BASE_URL = 'http://localhost:4000/api/v1';
        
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            results.appendChild(div);
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
        
        async function testAPI() {
            try {
                log('Testing API call...', 'info');
                
                const token = localStorage.getItem('accessToken');
                if (!token) {
                    log('No access token found', 'error');
                    return;
                }
                
                const userResponse = await fetch(`${API_BASE_URL}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!userResponse.ok) {
                    throw new Error(`User fetch failed: ${userResponse.status}`);
                }
                
                const userData = await userResponse.json();
                const userId = userData.data.id;
                
                log(`User ID: ${userId}`, 'success');
                
                const response = await fetch(`${API_BASE_URL}/user-conference-assignments?userId=${userId}&page=1&limit=100`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                log(`API Response: ${JSON.stringify(data, null, 2)}`, 'success');
                
                return data;
                
            } catch (error) {
                log(`API Error: ${error.message}`, 'error');
                return null;
            }
        }
        
        async function testFullFlow() {
            try {
                log('=== TESTING FULL CONFERENCE FLOW ===', 'info');
                
                // Step 1: Check authentication
                const step1 = document.createElement('div');
                step1.className = 'step';
                step1.innerHTML = '<h3>Step 1: Authentication Check</h3>';
                document.getElementById('results').appendChild(step1);
                
                const token = localStorage.getItem('accessToken');
                const userStr = localStorage.getItem('user');
                
                if (!token || !userStr) {
                    log('❌ No authentication data found', 'error');
                    return;
                }
                
                const user = JSON.parse(userStr);
                log(`✅ Authenticated as: ${user.name} (${user.role})`, 'success');
                
                // Step 2: Test API call
                const step2 = document.createElement('div');
                step2.className = 'step';
                step2.innerHTML = '<h3>Step 2: API Call Test</h3>';
                document.getElementById('results').appendChild(step2);
                
                const apiData = await testAPI();
                if (!apiData) {
                    log('❌ API call failed', 'error');
                    return;
                }
                
                // Step 3: Process data
                const step3 = document.createElement('div');
                step3.className = 'step';
                step3.innerHTML = '<h3>Step 3: Data Processing</h3>';
                document.getElementById('results').appendChild(step3);
                
                const assignments = apiData.data || [];
                log(`Found ${assignments.length} assignments`, 'info');
                
                if (assignments.length === 0) {
                    log('⚠️ No assignments found - will use fallback data', 'warning');
                    
                    // Simulate fallback data creation
                    const fallbackConferences = user.role === 'admin' || user.role === 'staff' ? [
                        {
                            conferenceId: 1,
                            conferenceName: 'Hội nghị Công nghệ 2024',
                            permissions: {
                                'conferences.view': true,
                                'conferences.create': true,
                                'conferences.update': true,
                                'conferences.delete': true,
                                'attendees.view': true,
                                'attendees.manage': true,
                                'checkin.manage': true,
                                'networking.view': true,
                                'venue.view': true,
                                'sessions.view': true,
                                'badges.view': true,
                                'analytics.view': true,
                                'my-events.view': true,
                                'roles.manage': true,
                                'mobile.view': true,
                            },
                            isActive: true
                        },
                        {
                            conferenceId: 2,
                            conferenceName: 'Hội nghị AI & Machine Learning',
                            permissions: {
                                'conferences.view': true,
                                'conferences.create': true,
                                'conferences.update': true,
                                'attendees.view': true,
                                'attendees.manage': true,
                                'checkin.manage': true,
                                'networking.view': true,
                                'venue.view': true,
                                'sessions.view': true,
                                'badges.view': true,
                                'analytics.view': true,
                                'my-events.view': true,
                                'roles.manage': true,
                                'mobile.view': true,
                            },
                            isActive: true
                        }
                    ] : [
                        {
                            conferenceId: 1,
                            conferenceName: 'Hội nghị Công nghệ 2024',
                            permissions: {
                                'conferences.view': true,
                                'attendees.view': true,
                                'networking.view': true,
                                'venue.view': true,
                                'sessions.view': true,
                                'badges.view': true,
                                'my-events.view': true,
                                'mobile.view': true,
                            },
                            isActive: true
                        }
                    ];
                    
                    log(`Created ${fallbackConferences.length} fallback conferences`, 'success');
                    
                    // Step 4: Test component logic
                    const step4 = document.createElement('div');
                    step4.className = 'step';
                    step4.innerHTML = '<h3>Step 4: Component Logic Test</h3>';
                    document.getElementById('results').appendChild(step4);
                    
                    const availableConferences = fallbackConferences.filter(cp => cp.isActive);
                    const currentConferenceId = availableConferences.length > 0 ? availableConferences[0].conferenceId : null;
                    const currentConferenceName = currentConferenceId ? 
                        availableConferences.find(c => c.conferenceId === currentConferenceId)?.conferenceName : 
                        "Chọn hội nghị";
                    
                    log(`Available conferences: ${availableConferences.length}`, 'success');
                    log(`Current conference ID: ${currentConferenceId}`, 'success');
                    log(`Current conference name: ${currentConferenceName}`, 'success');
                    
                    // Test display logic
                    if (availableConferences.length === 0) {
                        log('❌ No conferences available - component would show "Không có hội nghị"', 'error');
                    } else if (availableConferences.length === 1) {
                        log('✅ Single conference - component would show conference name only', 'success');
                    } else {
                        log('✅ Multiple conferences - component would show dropdown/selector', 'success');
                    }
                    
                    // Display conferences
                    availableConferences.forEach((conference, index) => {
                        const activePermissions = Object.entries(conference.permissions)
                            .filter(([_, isActive]) => isActive)
                            .map(([permissionCode, _]) => permissionCode);
                        
                        const conferenceDiv = document.createElement('div');
                        conferenceDiv.className = 'conference-item';
                        conferenceDiv.innerHTML = `
                            <h4>${conference.conferenceName}</h4>
                            <p><strong>ID:</strong> ${conference.conferenceId} | <strong>Active:</strong> ${conference.isActive ? 'Yes' : 'No'}</p>
                            <p><strong>Permissions:</strong> ${activePermissions.length} (${activePermissions.slice(0, 5).join(', ')}${activePermissions.length > 5 ? '...' : ''})</p>
                        `;
                        document.getElementById('results').appendChild(conferenceDiv);
                    });
                    
                } else {
                    log('✅ Found real assignments from API', 'success');
                    // Process real assignments here if needed
                }
                
                log('=== FLOW TEST COMPLETED ===', 'success');
                
            } catch (error) {
                log(`Flow test error: ${error.message}`, 'error');
            }
        }
        
        // Auto-run on load
        window.onload = function() {
            log('Page loaded. Click "Test Full Flow" to test the complete conference flow.');
        };
    </script>
</body>
</html>


