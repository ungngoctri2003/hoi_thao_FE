<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Google Authentication - Complete Flow</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.loading { background-color: #fff3cd; border: 1px solid #ffeaa7; }
        .status.success { background-color: #d4edda; border: 1px solid #c3e6cb; }
        .status.error { background-color: #f8d7da; border: 1px solid #f5c6cb; }
        .step {
            margin: 10px 0;
            padding: 10px;
            border-left: 4px solid #007bff;
            background-color: #f8f9fa;
        }
        .step.completed { border-left-color: #28a745; background-color: #d4edda; }
        .step.failed { border-left-color: #dc3545; background-color: #f8d7da; }
        .step.current { border-left-color: #ffc107; background-color: #fff3cd; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Test Google Authentication - Complete Flow</h1>
        <p>Trang n√†y ƒë·ªÉ test to√†n b·ªô flow Google authentication v√† ki·ªÉm tra xem user c√≥ ƒë∆∞·ª£c l∆∞u v√†o database kh√¥ng.</p>

        <div class="test-section info">
            <h3>üìã Test Flow:</h3>
            <div class="step" id="step1">
                <strong>Step 1:</strong> Ki·ªÉm tra Firebase configuration
            </div>
            <div class="step" id="step2">
                <strong>Step 2:</strong> Test Backend API endpoints
            </div>
            <div class="step" id="step3">
                <strong>Step 3:</strong> Test Google Authentication flow
            </div>
            <div class="step" id="step4">
                <strong>Step 4:</strong> Ki·ªÉm tra user ƒë∆∞·ª£c l∆∞u v√†o database
            </div>
            <div class="step" id="step5">
                <strong>Step 5:</strong> Verify authentication state
            </div>
        </div>

        <div class="test-section">
            <h3>üîç Current Status</h3>
            <div id="status" class="status loading">ƒêang kh·ªüi t·∫°o...</div>
        </div>

        <div class="test-section">
            <h3>üöÄ Test Actions</h3>
            <button onclick="runCompleteTest()" id="completeTestBtn">Run Complete Test</button>
            <button onclick="testFirebaseConfig()" id="firebaseBtn">Test Firebase Config</button>
            <button onclick="testBackendAPI()" id="backendBtn">Test Backend API</button>
            <button onclick="testGoogleAuth()" id="googleBtn">Test Google Auth</button>
            <button onclick="checkDatabase()" id="dbBtn">Check Database</button>
            <button onclick="clearLogs()" id="clearBtn">Clear Logs</button>
        </div>

        <div class="test-section">
            <h3>üìä Test Results</h3>
            <div id="testResults" class="log">Test results will appear here...</div>
        </div>

        <div class="test-section">
            <h3>üìù Detailed Logs</h3>
            <div id="logs" class="log">Detailed logs will appear here...</div>
        </div>
    </div>

    <script>
        let logs = [];
        let testResults = [];
        let currentStep = 0;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            logs.push(logEntry);
            
            const logsDiv = document.getElementById('logs');
            logsDiv.textContent = logs.join('\n');
            logsDiv.scrollTop = logsDiv.scrollHeight;
            
            console.log(logEntry);
        }

        function addTestResult(step, status, message, details = '') {
            testResults.push({ step, status, message, details, timestamp: new Date() });
            updateTestResults();
        }

        function updateTestResults() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.textContent = testResults.map(result => 
                `[${result.timestamp.toLocaleTimeString()}] ${result.step}: ${result.status.toUpperCase()} - ${result.message}`
            ).join('\n');
        }

        function clearLogs() {
            logs = [];
            testResults = [];
            document.getElementById('logs').textContent = 'Logs cleared...';
            document.getElementById('testResults').textContent = 'Test results cleared...';
            
            // Reset step indicators
            for (let i = 1; i <= 5; i++) {
                const step = document.getElementById(`step${i}`);
                step.className = 'step';
            }
            currentStep = 0;
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        function updateStep(stepNumber, status) {
            const step = document.getElementById(`step${stepNumber}`);
            step.className = `step ${status}`;
        }

        async function testFirebaseConfig() {
            log('Testing Firebase configuration...');
            updateStatus('üîÑ Testing Firebase configuration...', 'loading');
            updateStep(1, 'current');
            
            try {
                // Check if Firebase is available
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase not loaded');
                }
                
                // Check Firebase config
                const config = firebase.app().options;
                log(`Firebase project ID: ${config.projectId}`);
                log(`Firebase auth domain: ${config.authDomain}`);
                
                addTestResult('Firebase Config', 'success', 'Firebase configuration is valid', 
                    `Project: ${config.projectId}, Domain: ${config.authDomain}`);
                updateStep(1, 'completed');
                updateStatus('‚úÖ Firebase configuration is valid', 'success');
                
            } catch (error) {
                log(`Firebase config error: ${error.message}`, 'error');
                addTestResult('Firebase Config', 'failed', `Firebase configuration error: ${error.message}`);
                updateStep(1, 'failed');
                updateStatus('‚ùå Firebase configuration error', 'error');
            }
        }

        async function testBackendAPI() {
            log('Testing Backend API endpoints...');
            updateStatus('üîÑ Testing Backend API...', 'loading');
            updateStep(2, 'current');
            
            try {
                const testData = {
                    firebaseUid: 'test_uid_' + Date.now(),
                    email: 'test@example.com',
                    name: 'Test User',
                    avatar: 'https://example.com/avatar.jpg'
                };
                
                // Test Google login endpoint
                log('Testing Google login endpoint...');
                const loginResponse = await fetch('/api/auth/google/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });
                
                const loginResult = await loginResponse.json();
                log(`Login response: ${JSON.stringify(loginResult)}`);
                
                if (loginResponse.ok) {
                    log('‚úÖ Google login endpoint working', 'success');
                    addTestResult('Backend API', 'success', 'Google login endpoint is working');
                } else {
                    throw new Error(`Login endpoint error: ${loginResult.message}`);
                }
                
                // Test Google register endpoint
                log('Testing Google register endpoint...');
                const registerResponse = await fetch('/api/auth/google/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });
                
                const registerResult = await registerResponse.json();
                log(`Register response: ${JSON.stringify(registerResult)}`);
                
                if (registerResponse.ok) {
                    log('‚úÖ Google register endpoint working', 'success');
                    addTestResult('Backend API', 'success', 'Google register endpoint is working');
                } else {
                    throw new Error(`Register endpoint error: ${registerResult.message}`);
                }
                
                updateStep(2, 'completed');
                updateStatus('‚úÖ Backend API endpoints are working', 'success');
                
            } catch (error) {
                log(`Backend API error: ${error.message}`, 'error');
                addTestResult('Backend API', 'failed', `Backend API error: ${error.message}`);
                updateStep(2, 'failed');
                updateStatus('‚ùå Backend API error', 'error');
            }
        }

        async function testGoogleAuth() {
            log('Testing Google Authentication flow...');
            updateStatus('üîÑ Testing Google Authentication...', 'loading');
            updateStep(3, 'current');
            
            try {
                // Check if we're already authenticated
                const accessToken = localStorage.getItem('accessToken');
                const refreshToken = localStorage.getItem('refreshToken');
                
                if (accessToken && refreshToken) {
                    log('User already authenticated with tokens', 'success');
                    addTestResult('Google Auth', 'success', 'User already authenticated');
                    updateStep(3, 'completed');
                    updateStatus('‚úÖ User already authenticated', 'success');
                    return;
                }
                
                // Redirect to login page
                log('Redirecting to login page for Google authentication...');
                window.location.href = '/login';
                
            } catch (error) {
                log(`Google auth error: ${error.message}`, 'error');
                addTestResult('Google Auth', 'failed', `Google auth error: ${error.message}`);
                updateStep(3, 'failed');
                updateStatus('‚ùå Google auth error', 'error');
            }
        }

        async function checkDatabase() {
            log('Checking database for Google users...');
            updateStatus('üîÑ Checking database...', 'loading');
            updateStep(4, 'current');
            
            try {
                // This would require a backend endpoint to check database
                // For now, we'll check if we have user info from the current session
                const accessToken = localStorage.getItem('accessToken');
                
                if (accessToken) {
                    // Try to get current user info
                    const response = await fetch('/api/users/me', {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    
                    if (response.ok) {
                        const userInfo = await response.json();
                        log(`Current user info: ${JSON.stringify(userInfo)}`);
                        addTestResult('Database Check', 'success', 'User data found in database', 
                            `User: ${userInfo.name} (${userInfo.email})`);
                        updateStep(4, 'completed');
                        updateStatus('‚úÖ User data found in database', 'success');
                    } else {
                        throw new Error('Failed to get user info from database');
                    }
                } else {
                    throw new Error('No access token found - user not authenticated');
                }
                
            } catch (error) {
                log(`Database check error: ${error.message}`, 'error');
                addTestResult('Database Check', 'failed', `Database check error: ${error.message}`);
                updateStep(4, 'failed');
                updateStatus('‚ùå Database check error', 'error');
            }
        }

        async function verifyAuthState() {
            log('Verifying authentication state...');
            updateStatus('üîÑ Verifying authentication state...', 'loading');
            updateStep(5, 'current');
            
            try {
                const accessToken = localStorage.getItem('accessToken');
                const refreshToken = localStorage.getItem('refreshToken');
                const cookies = document.cookie;
                
                const authState = {
                    hasAccessToken: !!accessToken,
                    hasRefreshToken: !!refreshToken,
                    hasAccessTokenCookie: cookies.includes('accessToken='),
                    hasRefreshTokenCookie: cookies.includes('refreshToken='),
                    currentUrl: window.location.href
                };
                
                log(`Auth state: ${JSON.stringify(authState)}`);
                
                if (accessToken || cookies.includes('accessToken=')) {
                    addTestResult('Auth State', 'success', 'User is properly authenticated', 
                        `Tokens: ${authState.hasAccessToken ? 'localStorage' : 'cookies'}`);
                    updateStep(5, 'completed');
                    updateStatus('‚úÖ User is properly authenticated', 'success');
                } else {
                    throw new Error('No authentication tokens found');
                }
                
            } catch (error) {
                log(`Auth state verification error: ${error.message}`, 'error');
                addTestResult('Auth State', 'failed', `Auth state error: ${error.message}`);
                updateStep(5, 'failed');
                updateStatus('‚ùå Auth state verification failed', 'error');
            }
        }

        async function runCompleteTest() {
            log('Starting complete Google authentication test...');
            updateStatus('üîÑ Running complete test...', 'loading');
            
            clearLogs();
            
            try {
                await testFirebaseConfig();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                await testBackendAPI();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                await testGoogleAuth();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                await checkDatabase();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                await verifyAuthState();
                
                log('Complete test finished', 'success');
                updateStatus('‚úÖ Complete test finished', 'success');
                
            } catch (error) {
                log(`Complete test error: ${error.message}`, 'error');
                updateStatus('‚ùå Complete test failed', 'error');
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            log('Complete Google authentication test page loaded');
            updateStatus('Ready to test Google authentication', 'info');
            
            // Check if we're on callback page
            if (window.location.href.includes('/auth/google/callback')) {
                log('On callback page, waiting for processing...');
                updateStatus('üîÑ Processing Google authentication callback...', 'loading');
                
                // Wait and then run verification
                setTimeout(() => {
                    verifyAuthState();
                }, 3000);
            }
        });
    </script>
</body>
</html>