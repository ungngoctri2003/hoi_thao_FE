<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Google Authentication</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .section h2 {
            color: #333;
            margin-top: 0;
        }
        .button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .button:hover {
            background: #3367d6;
        }
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .info {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .error {
            background: #fdeaea;
            color: #d93025;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .success {
            background: #e6f4ea;
            color: #137333;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .user-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .user-info pre {
            background: #fff;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.connected {
            background: #e6f4ea;
            color: #137333;
        }
        .status.disconnected {
            background: #fdeaea;
            color: #d93025;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Test Google Authentication</h1>
        <p>Trang n√†y gi√∫p test t√≠nh nƒÉng ƒëƒÉng nh·∫≠p Google v·ªõi Firebase Authentication.</p>

        <!-- Firebase Setup Status -->
        <div class="section">
            <h2>üìã Tr·∫°ng th√°i Firebase</h2>
            <div id="firebase-status">
                <span class="status disconnected">Ch∆∞a k·∫øt n·ªëi</span>
                <p>Firebase ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o ho·∫∑c c·∫•u h√¨nh ch∆∞a ƒë√∫ng.</p>
            </div>
        </div>

        <!-- Authentication Section -->
        <div class="section">
            <h2>üîë X√°c th·ª±c Google</h2>
            <button id="google-signin-btn" class="button" disabled>
                ƒêƒÉng nh·∫≠p v·ªõi Google
            </button>
            <button id="google-signout-btn" class="button" disabled>
                ƒêƒÉng xu·∫•t
            </button>
            
            <div id="auth-status" class="info" style="display: none;">
                <strong>Tr·∫°ng th√°i:</strong> <span id="auth-status-text">Ch∆∞a ƒëƒÉng nh·∫≠p</span>
            </div>
        </div>

        <!-- User Information -->
        <div class="section">
            <h2>üë§ Th√¥ng tin ng∆∞·ªùi d√πng</h2>
            <div id="user-info" class="user-info" style="display: none;">
                <h3>Th√¥ng tin Firebase User:</h3>
                <pre id="user-details"></pre>
            </div>
        </div>

        <!-- Backend Integration Test -->
        <div class="section">
            <h2>üîó Test t√≠ch h·ª£p Backend</h2>
            <button id="test-backend-login" class="button" disabled>
                Test ƒëƒÉng nh·∫≠p Backend
            </button>
            <button id="test-backend-register" class="button" disabled>
                Test ƒëƒÉng k√Ω Backend
            </button>
            
            <div id="backend-status" class="info" style="display: none;">
                <strong>K·∫øt qu·∫£ Backend:</strong>
                <pre id="backend-result"></pre>
            </div>
        </div>

        <!-- Instructions -->
        <div class="section">
            <h2>üìñ H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</h2>
            <div class="info">
                <h3>B∆∞·ªõc 1: C·∫•u h√¨nh Firebase</h3>
                <ol>
                    <li>T·∫°o project Firebase t·∫°i <a href="https://console.firebase.google.com" target="_blank">Firebase Console</a></li>
                    <li>B·∫≠t Authentication v√† Google provider</li>
                    <li>L·∫•y th√¥ng tin c·∫•u h√¨nh v√† th√™m v√†o file <code>.env.local</code></li>
                    <li>Restart ·ª©ng d·ª•ng Next.js</li>
                </ol>
                
                <h3>B∆∞·ªõc 2: C·∫•u h√¨nh Backend</h3>
                <ol>
                    <li>Th√™m Firebase Admin SDK v√†o backend</li>
                    <li>T·∫°o endpoints <code>/auth/google/login</code> v√† <code>/auth/google/register</code></li>
                    <li>C·∫≠p nh·∫≠t database schema ƒë·ªÉ l∆∞u <code>firebase_uid</code></li>
                </ol>
                
                <h3>B∆∞·ªõc 3: Test</h3>
                <ol>
                    <li>Nh·∫•n "ƒêƒÉng nh·∫≠p v·ªõi Google" ƒë·ªÉ test Firebase</li>
                    <li>Nh·∫•n "Test ƒëƒÉng nh·∫≠p Backend" ƒë·ªÉ test t√≠ch h·ª£p</li>
                    <li>Ki·ªÉm tra console ƒë·ªÉ xem logs chi ti·∫øt</li>
                </ol>
            </div>
        </div>

        <!-- Environment Check -->
        <div class="section">
            <h2>üîß Ki·ªÉm tra Environment</h2>
            <div id="env-check">
                <p>ƒêang ki·ªÉm tra environment variables...</p>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCe5ebKWjE7xB7mq2-y9ZQKOg0a8lz6xKk",
            authDomain: "fun-chat-9e936.firebaseapp.com",
            databaseURL: "https://fun-chat-9e936-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "fun-chat-9e936",
            storageBucket: "fun-chat-9e936.firebasestorage.app",
            messagingSenderId: "888828957485",
            appId: "1:888828957485:web:47b2a523de9c75b0d839a4",
            measurementId: "G-4J4XC473RG"
        };

        // Initialize Firebase
        let app, auth, provider;
        let currentUser = null;

        function updateFirebaseStatus(connected) {
            const statusEl = document.getElementById('firebase-status');
            if (connected) {
                statusEl.innerHTML = '<span class="status connected">ƒê√£ k·∫øt n·ªëi</span><p>Firebase ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o th√†nh c√¥ng.</p>';
            } else {
                statusEl.innerHTML = '<span class="status disconnected">Ch∆∞a k·∫øt n·ªëi</span><p>Firebase ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o ho·∫∑c c·∫•u h√¨nh ch∆∞a ƒë√∫ng.</p>';
            }
        }

        function updateAuthStatus(user) {
            const statusEl = document.getElementById('auth-status');
            const statusTextEl = document.getElementById('auth-status-text');
            const signinBtn = document.getElementById('google-signin-btn');
            const signoutBtn = document.getElementById('google-signout-btn');
            const testLoginBtn = document.getElementById('test-backend-login');
            const testRegisterBtn = document.getElementById('test-backend-register');

            if (user) {
                statusEl.style.display = 'block';
                statusTextEl.textContent = 'ƒê√£ ƒëƒÉng nh·∫≠p';
                statusEl.className = 'success';
                signinBtn.disabled = true;
                signoutBtn.disabled = false;
                testLoginBtn.disabled = false;
                testRegisterBtn.disabled = false;
                currentUser = user;
                displayUserInfo(user);
            } else {
                statusEl.style.display = 'block';
                statusTextEl.textContent = 'Ch∆∞a ƒëƒÉng nh·∫≠p';
                statusEl.className = 'info';
                signinBtn.disabled = false;
                signoutBtn.disabled = true;
                testLoginBtn.disabled = true;
                testRegisterBtn.disabled = true;
                currentUser = null;
                hideUserInfo();
            }
        }

        function displayUserInfo(user) {
            const userInfoEl = document.getElementById('user-info');
            const userDetailsEl = document.getElementById('user-details');
            
            userInfoEl.style.display = 'block';
            userDetailsEl.textContent = JSON.stringify({
                uid: user.uid,
                email: user.email,
                displayName: user.displayName,
                photoURL: user.photoURL,
                emailVerified: user.emailVerified,
                providerData: user.providerData
            }, null, 2);
        }

        function hideUserInfo() {
            const userInfoEl = document.getElementById('user-info');
            userInfoEl.style.display = 'none';
        }

        function showBackendResult(result, isError = false) {
            const statusEl = document.getElementById('backend-status');
            const resultEl = document.getElementById('backend-result');
            
            statusEl.style.display = 'block';
            statusEl.className = isError ? 'error' : 'success';
            resultEl.textContent = JSON.stringify(result, null, 2);
        }

        function checkEnvironment() {
            const envCheckEl = document.getElementById('env-check');
            const requiredVars = [
                'NEXT_PUBLIC_FIREBASE_API_KEY',
                'NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN',
                'NEXT_PUBLIC_FIREBASE_PROJECT_ID',
                'NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET',
                'NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID',
                'NEXT_PUBLIC_FIREBASE_APP_ID'
            ];

            let html = '<h3>Environment Variables:</h3><ul>';
            let allPresent = true;

            requiredVars.forEach(varName => {
                // In a real app, these would be available via process.env
                // For this demo, we'll just show the variable names
                html += `<li>${varName}: <span style="color: #666;">(c·∫ßn c·∫•u h√¨nh trong .env.local)</span></li>`;
            });

            html += '</ul>';
            
            if (allPresent) {
                html += '<p style="color: green;">‚úÖ T·∫•t c·∫£ environment variables ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh</p>';
            } else {
                html += '<p style="color: red;">‚ùå M·ªôt s·ªë environment variables ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh</p>';
            }

            envCheckEl.innerHTML = html;
        }

        // Initialize Firebase
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            provider = new GoogleAuthProvider();
            
            provider.setCustomParameters({
                prompt: 'select_account'
            });

            updateFirebaseStatus(true);

            // Listen for auth state changes
            onAuthStateChanged(auth, (user) => {
                updateAuthStatus(user);
            });

        } catch (error) {
            console.error('Firebase initialization error:', error);
            updateFirebaseStatus(false);
        }

        // Event listeners
        document.getElementById('google-signin-btn').addEventListener('click', async () => {
            try {
                const result = await signInWithPopup(auth, provider);
                console.log('Google sign-in successful:', result.user);
            } catch (error) {
                console.error('Google sign-in error:', error);
                alert('L·ªói ƒëƒÉng nh·∫≠p Google: ' + error.message);
            }
        });

        document.getElementById('google-signout-btn').addEventListener('click', async () => {
            try {
                await signOut(auth);
                console.log('Google sign-out successful');
            } catch (error) {
                console.error('Google sign-out error:', error);
                alert('L·ªói ƒëƒÉng xu·∫•t: ' + error.message);
            }
        });

        document.getElementById('test-backend-login').addEventListener('click', async () => {
            if (!currentUser) {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p Google tr∆∞·ªõc');
                return;
            }

            try {
                const response = await fetch('/api/auth/google/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        firebaseUid: currentUser.uid,
                        email: currentUser.email,
                        name: currentUser.displayName,
                        avatar: currentUser.photoURL
                    })
                });

                const result = await response.json();
                showBackendResult(result, !response.ok);
            } catch (error) {
                showBackendResult({ error: error.message }, true);
            }
        });

        document.getElementById('test-backend-register').addEventListener('click', async () => {
            if (!currentUser) {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p Google tr∆∞·ªõc');
                return;
            }

            try {
                const response = await fetch('/api/auth/google/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        firebaseUid: currentUser.uid,
                        email: currentUser.email,
                        name: currentUser.displayName,
                        avatar: currentUser.photoURL
                    })
                });

                const result = await response.json();
                showBackendResult(result, !response.ok);
            } catch (error) {
                showBackendResult({ error: error.message }, true);
            }
        });

        // Check environment on load
        checkEnvironment();
    </script>
</body>
</html>
