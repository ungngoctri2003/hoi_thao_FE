<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebSocket Connection Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .log {
        background: #f5f5f5;
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
      }
      .success {
        color: green;
      }
      .error {
        color: red;
      }
      .info {
        color: blue;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h1>WebSocket Connection Test</h1>

    <div>
      <button onclick="testTokenRetrieval()">Test Token Retrieval</button>
      <button onclick="testWebSocketConnection()">
        Test WebSocket Connection
      </button>
      <button onclick="clearLogs()">Clear Logs</button>
    </div>

    <div id="logs"></div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
      function log(message, type = "info") {
        const logs = document.getElementById("logs");
        const div = document.createElement("div");
        div.className = `log ${type}`;
        div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logs.appendChild(div);
        logs.scrollTop = logs.scrollHeight;
      }

      function clearLogs() {
        document.getElementById("logs").innerHTML = "";
      }

      function testTokenRetrieval() {
        log("üîç Testing token retrieval...", "info");

        // Test localStorage
        const localStorageToken = localStorage.getItem("accessToken");
        log(
          `LocalStorage token: ${
            localStorageToken
              ? localStorageToken.substring(0, 20) + "..."
              : "none"
          }`,
          localStorageToken ? "success" : "error"
        );

        // Test cookies
        const cookies = document.cookie.split(";");
        const tokenCookie = cookies.find((cookie) =>
          cookie.trim().startsWith("accessToken=")
        );
        if (tokenCookie) {
          const token = tokenCookie.split("=")[1];
          const decodedToken = decodeURIComponent(token);
          log(`Cookie token: ${decodedToken.substring(0, 20)}...`, "success");
          log(`Cookie token length: ${decodedToken.length}`, "info");
          log(
            `Cookie token format: ${
              decodedToken.split(".").length === 3 ? "Valid JWT" : "Invalid JWT"
            }`,
            decodedToken.split(".").length === 3 ? "success" : "error"
          );
        } else {
          log("No token found in cookies", "error");
        }

        // Test both methods
        const finalToken =
          localStorageToken ||
          (tokenCookie ? decodeURIComponent(tokenCookie.split("=")[1]) : null);
        log(
          `Final token to use: ${
            finalToken ? finalToken.substring(0, 20) + "..." : "none"
          }`,
          finalToken ? "success" : "error"
        );

        return finalToken;
      }

      function testWebSocketConnection() {
        const token = testTokenRetrieval();

        if (!token) {
          log("‚ùå No token available for WebSocket connection", "error");
          return;
        }

        log("üîå Attempting WebSocket connection...", "info");

        const socket = io("http://localhost:4000", {
          path: "/ws",
          auth: {
            token: token,
          },
          extraHeaders: {
            Authorization: `Bearer ${token}`,
          },
          transports: ["websocket", "polling"],
          timeout: 10000,
          reconnection: true,
          reconnectionAttempts: 3,
          reconnectionDelay: 1000,
          forceNew: true,
        });

        socket.on("connect", () => {
          log("‚úÖ WebSocket connected successfully!", "success");
          log(`Socket ID: ${socket.id}`, "info");
          socket.disconnect();
        });

        socket.on("connect_error", (error) => {
          log(`‚ùå WebSocket connection error: ${error.message}`, "error");
          log(
            `Error details: ${JSON.stringify({
              message: error.message,
              name: error.name,
              description: error.description,
              context: error.context,
              type: error.type,
            })}`,
            "error"
          );
        });

        socket.on("disconnect", (reason) => {
          log(`üîå WebSocket disconnected: ${reason}`, "info");
        });

        // Timeout after 15 seconds
        setTimeout(() => {
          if (socket.connected) {
            log("‚úÖ Connection test completed successfully", "success");
            socket.disconnect();
          } else {
            log("‚è∞ Connection test timed out", "error");
          }
        }, 15000);
      }

      // Auto-run token retrieval on page load
      window.onload = function () {
        log("üöÄ WebSocket Connection Test Page Loaded", "info");
        testTokenRetrieval();
      };
    </script>
  </body>
</html>

