<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test User Info Display</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .success {
            color: green;
            font-weight: bold;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        .info {
            background-color: #e7f3ff;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .log {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .user-info {
            background-color: #f0f8ff;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            margin: 10px 0;
        }
        .dashboard-preview {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            margin: 10px 0;
        }
    </style>
</head>
<body>ls app/*/page.tsx | grep -v dashboard | grep -v login | grep -v register | grep -v forgot-password | grep -v reset-passwordnfo Display After Login</h1>
    
    <div class="container">
        <h2>1. Đăng ký và đăng nhập</h2>
        <form id="authForm">
            <div class="form-group">
                <label for="name">Họ tên:</label>
                <input type="text" id="name" name="name" required>
            </div>
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" name="email" required>
            </div>
            <div class="form-group">
                <label for="password">Mật khẩu:</label>
                <input type="password" id="password" name="password" required>
            </div>
            <button type="button" onclick="registerAndLogin()">Đăng ký và đăng nhập</button>
            <button type="button" onclick="loginOnly()">Chỉ đăng nhập</button>
        </form>
        <div id="authResult"></div>
    </div>

    <div class="container">
        <h2>2. Thông tin người dùng hiện tại</h2>
        <button onclick="getCurrentUserInfo()">Lấy thông tin người dùng</button>
        <button onclick="simulateDashboard()">Mô phỏng Dashboard</button>
        <div id="userInfo"></div>
    </div>

    <div class="container">
        <h2>3. Test các component hiển thị</h2>
        <button onclick="testProfileComponent()">Test Profile Component</button>
        <button onclick="testDashboardComponents()">Test Dashboard Components</button>
        <button onclick="testHeaderSidebar()">Test Header & Sidebar</button>
        <div id="componentTest"></div>
    </div>

    <div class="container">
        <h2>4. Log Console</h2>
        <div id="consoleLog" class="log"></div>
        <button onclick="clearLog()">Xóa log</button>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:4000/api/v1';
        let logContainer = document.getElementById('consoleLog');
        let currentUser = null;
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logContainer.textContent += `[${timestamp}] ${message}\n`;
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            logContainer.textContent = '';
        }
        
        function showResult(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${isError ? 'error' : 'success'}">${message}</div>`;
        }
        
        function showUserInfo(elementId, userInfo) {
            const element = document.getElementById(elementId);
            element.innerHTML = `
                <div class="user-info">
                    <h3>Thông tin người dùng:</h3>
                    <p><strong>ID:</strong> ${userInfo.id}</p>
                    <p><strong>Tên:</strong> ${userInfo.name}</p>
                    <p><strong>Email:</strong> ${userInfo.email}</p>
                    <p><strong>Role:</strong> ${userInfo.role}</p>
                    <p><strong>Permissions:</strong> ${userInfo.permissions ? userInfo.permissions.join(', ') : 'N/A'}</p>
                </div>
            `;
        }
        
        // Đăng ký và đăng nhập
        async function registerAndLogin() {
            const formData = new FormData(document.getElementById('authForm'));
            const data = {
                name: formData.get('name'),
                email: formData.get('email'),
                password: formData.get('password')
            };
            
            log(`Đang đăng ký tài khoản: ${data.email}`);
            
            try {
                // Đăng ký
                const registerResponse = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const registerResult = await registerResponse.json();
                
                if (registerResponse.ok) {
                    log(`Đăng ký thành công: ${JSON.stringify(registerResult)}`);
                    
                    // Đăng nhập
                    log('Đang đăng nhập...');
                    const loginResponse = await fetch(`${API_BASE_URL}/auth/login`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            email: data.email,
                            password: data.password
                        })
                    });
                    
                    const loginResult = await loginResponse.json();
                    
                    if (loginResponse.ok) {
                        log(`Đăng nhập thành công: ${JSON.stringify(loginResult)}`);
                        
                        // Lưu token
                        if (loginResult.data.accessToken) {
                            localStorage.setItem('accessToken', loginResult.data.accessToken);
                            localStorage.setItem('refreshToken', loginResult.data.refreshToken);
                            log('Token đã được lưu vào localStorage');
                        }
                        
                        showResult('authResult', 'Đăng ký và đăng nhập thành công!');
                        
                        // Tự động lấy thông tin người dùng
                        setTimeout(() => {
                            getCurrentUserInfo();
                        }, 1000);
                    } else {
                        log(`Đăng nhập thất bại: ${loginResult.message}`);
                        showResult('authResult', `Lỗi đăng nhập: ${loginResult.message}`, true);
                    }
                } else {
                    log(`Đăng ký thất bại: ${registerResult.message}`);
                    showResult('authResult', `Lỗi đăng ký: ${registerResult.message}`, true);
                }
            } catch (error) {
                log(`Lỗi: ${error.message}`);
                showResult('authResult', `Lỗi: ${error.message}`, true);
            }
        }
        
        // Chỉ đăng nhập
        async function loginOnly() {
            const formData = new FormData(document.getElementById('authForm'));
            const data = {
                email: formData.get('email'),
                password: formData.get('password')
            };
            
            log(`Đang đăng nhập: ${data.email}`);
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    log(`Đăng nhập thành công: ${JSON.stringify(result)}`);
                    
                    // Lưu token
                    if (result.data.accessToken) {
                        localStorage.setItem('accessToken', result.data.accessToken);
                        localStorage.setItem('refreshToken', result.data.refreshToken);
                        log('Token đã được lưu vào localStorage');
                    }
                    
                    showResult('authResult', 'Đăng nhập thành công!');
                    
                    // Tự động lấy thông tin người dùng
                    setTimeout(() => {
                        getCurrentUserInfo();
                    }, 1000);
                } else {
                    log(`Đăng nhập thất bại: ${result.message}`);
                    showResult('authResult', `Lỗi: ${result.message}`, true);
                }
            } catch (error) {
                log(`Lỗi đăng nhập: ${error.message}`);
                showResult('authResult', `Lỗi: ${error.message}`, true);
            }
        }
        
        // Lấy thông tin người dùng
        async function getCurrentUserInfo() {
            const token = localStorage.getItem('accessToken');
            
            if (!token) {
                showResult('userInfo', 'Chưa đăng nhập', true);
                return;
            }
            
            log('Đang lấy thông tin người dùng...');
            
            try {
                // Lấy thông tin profile
                const profileResponse = await fetch(`${API_BASE_URL}/profile`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    }
                });
                
                // Lấy permissions
                const meResponse = await fetch(`${API_BASE_URL}/users/me`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    }
                });
                
                if (profileResponse.ok && meResponse.ok) {
                    const profileData = await profileResponse.json();
                    const meData = await meResponse.json();
                    
                    log(`Thông tin profile: ${JSON.stringify(profileData)}`);
                    log(`Thông tin permissions: ${JSON.stringify(meData)}`);
                    
                    const userData = profileData.data.user;
                    const permissions = meData.data.permissions || [];
                    
                    // Xác định role
                    let role = 'attendee';
                    if (permissions.includes('roles.admin')) {
                        role = 'admin';
                    } else if (permissions.includes('conferences.create') || permissions.includes('conferences.update')) {
                        role = 'staff';
                    }
                    
                    currentUser = {
                        id: userData.ID,
                        email: userData.EMAIL,
                        name: userData.NAME,
                        role: role,
                        permissions: permissions
                    };
                    
                    log(`Thông tin người dùng: ${JSON.stringify(currentUser)}`);
                    showUserInfo('userInfo', currentUser);
                } else {
                    log(`Lỗi lấy thông tin: Profile=${profileResponse.status}, Me=${meResponse.status}`);
                    showResult('userInfo', 'Lỗi lấy thông tin người dùng', true);
                }
            } catch (error) {
                log(`Lỗi lấy thông tin người dùng: ${error.message}`);
                showResult('userInfo', `Lỗi: ${error.message}`, true);
            }
        }
        
        // Mô phỏng Dashboard
        function simulateDashboard() {
            if (!currentUser) {
                showResult('userInfo', 'Vui lòng đăng nhập trước', true);
                return;
            }
            
            const dashboardHtml = `
                <div class="dashboard-preview">
                    <h3>Mô phỏng Dashboard cho ${currentUser.role}</h3>
                    <div class="user-info">
                        <h4>Header sẽ hiển thị:</h4>
                        <p><strong>Tên người dùng:</strong> ${currentUser.name}</p>
                        <p><strong>Role:</strong> ${currentUser.role}</p>
                    </div>
                    <div class="user-info">
                        <h4>Sidebar sẽ hiển thị:</h4>
                        <p><strong>Role badge:</strong> ${getRoleLabel(currentUser.role)}</p>
                        <p><strong>Menu items:</strong> ${getMenuItems(currentUser.role).join(', ')}</p>
                    </div>
                    <div class="user-info">
                        <h4>Dashboard content sẽ hiển thị:</h4>
                        <p><strong>Welcome message:</strong> Chào mừng, ${currentUser.name}!</p>
                        <p><strong>Dashboard type:</strong> ${getDashboardType(currentUser.role)}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('userInfo').innerHTML = dashboardHtml;
            log(`Mô phỏng dashboard cho role: ${currentUser.role}`);
        }
        
        function getRoleLabel(role) {
            const labels = {
                admin: 'Quản trị viên',
                staff: 'Nhân viên',
                attendee: 'Tham dự'
            };
            return labels[role] || 'Tham dự';
        }
        
        function getMenuItems(role) {
            const menus = {
                admin: ['Tổng quan', 'Quản lý hội nghị', 'Danh sách tham dự', 'Check-in QR', 'Kết nối mạng', 'Bản đồ địa điểm', 'Phiên trực tiếp', 'Huy hiệu số', 'Phân tích AI', 'Ứng dụng di động', 'Phân quyền', 'Nhật ký hệ thống', 'Cài đặt'],
                staff: ['Tổng quan', 'Danh sách tham dự', 'Check-in QR', 'Kết nối mạng', 'Bản đồ địa điểm', 'Phiên trực tiếp', 'Huy hiệu số', 'Ứng dụng di động'],
                attendee: ['Trang chủ', 'Sự kiện của tôi', 'Kết nối mạng', 'Bản đồ địa điểm', 'Phiên trực tiếp', 'Huy hiệu của tôi', 'Ứng dụng di động']
            };
            return menus[role] || menus.attendee;
        }
        
        function getDashboardType(role) {
            const types = {
                admin: 'AdminDashboard - Tổng quan hệ thống',
                staff: 'StaffDashboard - Bảng điều khiển nhân viên',
                attendee: 'AttendeeDashboard - Quản lý sự kiện cá nhân'
            };
            return types[role] || types.attendee;
        }
        
        // Test các component
        function testProfileComponent() {
            if (!currentUser) {
                showResult('componentTest', 'Vui lòng đăng nhập trước', true);
                return;
            }
            
            const profileHtml = `
                <div class="dashboard-preview">
                    <h3>Test Profile Component</h3>
                    <div class="user-info">
                        <h4>Profile component sẽ hiển thị:</h4>
                        <p><strong>Tên:</strong> ${currentUser.name}</p>
                        <p><strong>Email:</strong> ${currentUser.email}</p>
                        <p><strong>Role:</strong> ${getRoleLabel(currentUser.role)}</p>
                        <p><strong>Avatar:</strong> User icon với tên ${currentUser.name}</p>
                        <p><strong>Edit button:</strong> Có thể chỉnh sửa tên và email</p>
                    </div>
                </div>
            `;
            
            document.getElementById('componentTest').innerHTML = profileHtml;
            log(`Test profile component cho user: ${currentUser.name}`);
        }
        
        function testDashboardComponents() {
            if (!currentUser) {
                showResult('componentTest', 'Vui lòng đăng nhập trước', true);
                return;
            }
            
            const dashboardHtml = `
                <div class="dashboard-preview">
                    <h3>Test Dashboard Components</h3>
                    <div class="user-info">
                        <h4>Dashboard components sẽ hiển thị:</h4>
                        <p><strong>AdminDashboard:</strong> ${currentUser.role === 'admin' ? 'Sẽ hiển thị' : 'Không hiển thị'}</p>
                        <p><strong>StaffDashboard:</strong> ${currentUser.role === 'staff' ? 'Sẽ hiển thị' : 'Không hiển thị'}</p>
                        <p><strong>AttendeeDashboard:</strong> ${currentUser.role === 'attendee' ? 'Sẽ hiển thị' : 'Không hiển thị'}</p>
                        <p><strong>Welcome message:</strong> Chào mừng, ${currentUser.name}!</p>
                    </div>
                </div>
            `;
            
            document.getElementById('componentTest').innerHTML = dashboardHtml;
            log(`Test dashboard components cho role: ${currentUser.role}`);
        }
        
        function testHeaderSidebar() {
            if (!currentUser) {
                showResult('componentTest', 'Vui lòng đăng nhập trước', true);
                return;
            }
            
            const headerSidebarHtml = `
                <div class="dashboard-preview">
                    <h3>Test Header & Sidebar</h3>
                    <div class="user-info">
                        <h4>Header sẽ hiển thị:</h4>
                        <p><strong>User name:</strong> ${currentUser.name}</p>
                        <p><strong>User role:</strong> ${getRoleLabel(currentUser.role)}</p>
                        <p><strong>User menu:</strong> Dropdown với thông tin cá nhân</p>
                    </div>
                    <div class="user-info">
                        <h4>Sidebar sẽ hiển thị:</h4>
                        <p><strong>Role badge:</strong> ${getRoleLabel(currentUser.role)}</p>
                        <p><strong>Navigation items:</strong> ${getMenuItems(currentUser.role).length} items</p>
                        <p><strong>ConferenceMS title:</strong> Với role badge</p>
                    </div>
                </div>
            `;
            
            document.getElementById('componentTest').innerHTML = headerSidebarHtml;
            log(`Test header & sidebar cho user: ${currentUser.name} (${currentUser.role})`);
        }
        
        // Kiểm tra trạng thái ban đầu
        window.addEventListener('load', () => {
            log('Trang test đã được tải');
            const token = localStorage.getItem('accessToken');
            if (token) {
                log('Phát hiện token trong localStorage, lấy thông tin người dùng...');
                getCurrentUserInfo();
            }
        });
    </script>
</body>
</html>
